# Инфо:
# 
# 1. Отобразить инфо о дисках и разделах: lsblk -f
# 2. Разметка диска новыми разделами (partition): fdisk /dev/<название устройства>
# 2.1. fdisk /dev/vdb далее g (создание таблицы разделов gpt) далее w (сохр. изменения и выйти)
# 3. Создание раздела диска (partition) и physical volume вместе с ним: fdisk /dev/<название устройства>
# 3.1. fdisk /dev/vdb далее n (создание раздела) далее 1 (номер раздела) далее enter (вопрос про секторы) далее w (сохр. изменения и выйти)
# 4. Инициализация Physical Volume: pvcreate /dev/<название раздела>
# 4.1. pvcreate /dev/vdb1 
# 5. Создание Volume Group: vgcreate <имя группы томов> /dev/<имя раздела>
# 5.1. vgcreate vg-db-storage /dev/vdb1 (vgs - проверка, что VG создан)
# 6. Cоздание Logical Volume: lvcreate -n <имя LV> -l <кол-во extents (можно посмотреть vgdisplay <имя VG>)> <имя VG>
# lvcreate -n lv-vhdd-1-monitoring-system-db -l 7167 vg-db-storage (lvs - проверка, что LV создан)
# 7. Форматирование LV и создание файловой системы ext4
# mkfs.ext4 /dev/vg-db-storage/lv-vhdd-1-monitoring-system-db
# 8. Создание точки монтирования
# mkdir /opt/vhdd-1-monitoring-system-db/
# 9. Монтирование LV
# mount /dev/vg-db-storage/lv-vhdd-1-monitoring-system-db /opt/vhdd-1-monitoring-system-db/
# 10. Добавить LV в автомонтирование /etc/fstab
# echo "/dev/vg-db-storage/lv-vhdd-1-monitoring-system-db /opt/vhdd-1-monitoring-system-db/ ext4 defaults 0 0" | sudo tee -a /etc/fstab



---
- name: LVM Testing
  hosts: vm-1-monitoring-system
  become: true
  gather_facts: False
  tasks:
    # Создание раздела
    # Проверка создания раздела "lsblk"
    - name: Partition /dev/vdb disk
      community.general.parted:
        device: /dev/vdb
        number: 1
        flags: [ lvm ]
        label: "gpt"
        state: present
        part_end: "100%"

    # Создание Volume Group
    # Проверка: "vgs"
    - name: Task for PV and VG
      community.general.lvg:
          vg: vg-db-storage
          pvs: /dev/vdb1

    # Создание Logical Volume
    # Проверка: "lvs"
    - name: Logical volume with size
      community.general.lvol:
        vg: vg-db-storage
        lv: lv-vhdd-1-monitoring-system-db
        size: 100%FREE
    
    # Форматирование раздела и создание файловой системы
    # Проверка: "lsblk -f"
    - name: Format the volume with ext4 fs
      community.general.filesystem:
        fstype: ext4
        dev: /dev/vg-db-storage/lv-vhdd-1-monitoring-system-db
    
    # Создание директории для монтирования жеского диска
    - name: Target directory under /opt/
      ansible.builtin.file:
        path: /opt/vhdd-1-monitoring-system-db/
        state: directory
        mode: '0755'
    
    # Монтирование жеского диска
    # Проверка, что жеский диск смонтирован "lsblk -f" 
    # Проверка, что жесткий диск добавлен в автозагрузку "cat /etc/fstab"
    # Проверка, что все файловые системы из "/etc/fstab" корректно монтируются
    - name: mount the lv on /opt/vhdd-1-monitoring-system-db/
      ansible.posix.mount:
        path: /opt/vhdd-1-monitoring-system-db/
        src: /dev/vg-db-storage/lv-vhdd-1-monitoring-system-db
        fstype: ext4
        state: mounted


# Для инфо:

# 1. Размонтирование директории: 
# 1.1. Просмотреть path точки монтирования: lsblk -f
# 1.2. Размонтировать директорию: umount <path>
# umount /opt/vhdd-1-monitoring-system-db/

# 2. Удалить Logical Volume:
# 2.1. Просмотреть Logical Volume: lvdisplay
# 2.2. Удалить Logical Volume: lvremove <path>
# lvremove /dev/vg-db-storage/lv-vhdd-1-monitoring-system-db

# 3. Удалить Volume Group:
# 3.1. Просмотреть Volume Group: vgdisplay
# 3.2. Удалить Volume Group: vgremove <name>
# vgremove vg-db-storage

# 4. Удалить partition:
# 4.1. Просмотреть partition: fdisk -l -a или lsblk -f
# 4.2. Удалить Volume Group: fdisk <path> 
# fdisk /dev/vdb далее p (просмотр сущ. разделов) далее d (удалить раздел) далее выбрать номер раздела далее w (сохранить изменени

