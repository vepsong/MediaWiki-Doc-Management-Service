# Manual Failover From the Primary PostgreSQL to the Standby PostgreSQL

## Promoting the Standby to Primary

Target VM: Current StanbBy Postgresql - {{ showTooltip_VM_7() }}

- Steps:

    - Step 1 - Changing user to postgres
        
            sudo su -postgresql

    - Step 2 - Promoting the Standby to Primary

            # -D - data directory of the PostgreSQL
            /usr/lib/postgresql/14/bin/pg_ctl promote -D {{postgresql_database_vhdd_2_disk_data_dir}}

            # In case of 'pg_ctl: command not found', run this command to locate pg_ctl
            find / -name pg_ctl 2>/dev/null   

    - Step 3 - Verify the Promotion

            # Entrance to psql
            psql

            # Verifying the status
            SELECT pg_is_in_recovery();

            # It should return the 'f' output

                postgres=# SELECT pg_is_in_recovery();
                pg_is_in_recovery
                -------------------
                f
                (1 row)

## Changing the MediaWiki servers settings

Target VM: {{ showTooltip_VM_3() }}, {{ showTooltip_VM_4() }}

- Steps:

    <details class="tasks_external_code_rendering">
    <summary>- Step 1 - Configuring the ``$wgDBserver`` in ``/var/www/mediawiki/LocalSettings.php``</summary>

        # The new Primary IP or DNS addres
        $wgDBserver = '{{vm_7_ip_address}}'

    </details>

## Changing settings on the new Primary Postgresql

Target VM: {{ showTooltip_VM_7() }}

- Steps:

    <details class="tasks_external_code_rendering">
    <summary>- Step 1 - Stopping the PostgreSQL service</summary>

        systemctl stop postgresql
        systemctl status postgresql

    </details>

    <details class="tasks_external_code_rendering">
    <summary>- Step 2 - Configuring the ``wal_level`` in ``/etc/postgresql/14/main/postgresql.conf``</summary>

        #wal_level = '' >>>
        wal_level = replica

    </details>

    <details class="tasks_external_code_rendering">
    <summary>- Step 3 - Restarting the PostgreSQL service</summary>

        systemctl restart postgresql
        systemctl status postgresql

    </details>


## Disconnect "{{postgresql_database_vhdd_3_disk_name}}" from the new Primary VM (VM-7) and attach it to the new Standby VM (VM-6) using the Yandex Cloud Web interface

## Mounting the "{{postgresql_database_vhdd_3_disk_name}}" to the new Standby VM (VM-6) mount point

- Look at the Run Ansible PipeLine page




