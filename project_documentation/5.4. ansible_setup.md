<!-- # Настройка Ansible для автоматической конфигурации сервиса -->

#### Настройка Ansible для автоматической конфигурации сервиса

1. Запуск Python-скрипта [**update_ansible_inventory.py**](python-scripts/update_ansible_inventory.py) для автоматического и динамического формирования inventory.yaml

- Cкрипт содержит в себе вызовы сторонних скриптов: 
  - [update_ansible_meta.py](python-scripts/update_ansible_meta.py) - Создание файла "ansible_meta.json" с мета-данными Ansible
  - [add_env_var.py](python-scripts/add_env_var.py) - Создание файла "terraform_vm_data.json" c данными ВМ

- Cкрипт содержит в себе вызовы функций из сторонних скриптов: 
  - [from data_handler_update_ansible_inventory](python-scripts/data_handler_update_ansible_inventory.py) import create_group_vars, get_vm_info - Обработка данных из "ansible_meta.json" и "terraform_vm_data.json"
  - **from [ansible_structure](python-scripts/ansible_structure.py) import dynamic_groups**


        # ansible_structure.py содержит словарь dynamic_groups
        # Он предназначен для выстраивания структуры групп, подгрупп и входящих в них ВМ.
        # Он уже настроен. Но, при необходимости, можно менять структуру файла inventory.yaml

        # Просмотреть список созданных через Terraform ВМ      
        ~/<имя репозитория>/<папка Terraform> terraform output 
        # Или в файле ~/<имя репозитория>/<папка Terraform>/terraform.tfstate

2. Pipeline по запуску playbook'ов playbook
   - Монтирование внешних жестких дисков, инициализация LVM.  
      - Будут созданы: disk Partition, Physical Volume, Group Volume, Logical Volume, точка монтирования в /opt, запись в /etc/fstab для автомонтирования диска после перезапуска ВМ

            ansible-playbook mount_disks_playbook.yaml -i inventory.yaml

   - Установка и настройка zabbix-server, zabbix-agent, keepalived в группe хостов "proxy_and_monitoring" (vm-2, vm-3)

         ansible-playbook playbook.yaml -i inventory.yaml --tags="install_zabbix_agent_and_proxy"  


3. Дополнительная информация

- Основные команды для работы с Ansible  
  Выполнять из директории с файлами Ansible
  
  <details>
  <summary>Развернуть</summary>  
      
      # Проверка синтаксиса и доступности облачных ресурсов
      ansible all -m ping -i inventory.yaml  

      # Установка или обновление коллекции
      ansible-galaxy collection install <имя коллекции>  

      # Список установленных коллекций
      ansible-galaxy collection list  

      # Создание роли (исп. для разграничения задач, которые будут выполняться в рамках playbook)
      ansible-galaxy init <название роли>

      # Список используемых ролей
      ansible-galaxy role list  

      # Запуск playbook
      ansible-playbook <название playbook>.yaml -i <название файла с inventory>.yaml --tags="<указать тэг>"

        Пример:
        ansible-playbook mount_disks_playbook.yaml -i inventory.yaml --tags="moint_dir"


  </details> 
