<!-- # Настройка Ansible для автоматической конфигурации сервиса -->

#### Настройка Ansible для автоматической конфигурации сервиса

1. Запуск Python-скрипта [**update_ansible_inventory.py**](python-scripts/update_ansible_inventory.py) для автоматического и динамического формирования inventory.yaml

- Cкрипт содержит в себе вызовы сторонних скриптов: 
  - [update_ansible_meta.py](python-scripts/update_ansible_meta.py) - Создание файла "ansible_meta.json" с мета-данными Ansible
  - [add_env_var.py](python-scripts/add_env_var.py) - Создание файла "terraform_vm_data.json" c данными ВМ

- Cкрипт содержит в себе вызовы функций из сторонних скриптов: 
  - [from data_handler_update_ansible_inventory](python-scripts/data_handler_update_ansible_inventory.py) import create_group_vars, get_vm_info - Обработка данных из "ansible_meta.json" и "terraform_vm_data.json"
  - **from [ansible_structure](python-scripts/ansible_structure.py) import dynamic_groups**


        # ansible_structure.py содержит словарь dynamic_groups
        # Он предназначен для выстраивания структуры групп, подгрупп и входящих в них ВМ.
        # Он уже настроен. Но, при необходимости, можно менять структуру файла inventory.yaml

        # Просмотреть список созданных через Terraform ВМ      
        ~/<имя репозитория>/<папка Terraform> terraform output 
        # Или в файле ~/<имя репозитория>/<папка Terraform>/terraform.tfstate

2. Guideline по запуску playbook'ов playbook
   - #### Изменение имени хостов всех ВМ
          
         ansible-playbook playbook.yaml -i inventory.yaml --tags="change_hostname"

   - #### Монтирование внешних жестких дисков, инициализация LVM.  
      - Будут созданы: disk Partition, Physical Volume, Group Volume, Logical Volume, точка монтирования в /opt, запись в /etc/fstab для автомонтирования диска после перезапуска ВМ

            ansible-playbook playbook.yaml -i inventory.yaml --tags="mount_external_disks"

   - Размонтирование внешних жестких дисков, деинициализация LVM.  

         ansible-playbook playbook.yaml -i inventory.yaml --tags="unmount_external_disks"

   - #### Инициализация и настройка postgresql на vm-1-monitoring-system, vm-6-primary-db, vm-7-standby-db

      - [Создание файла с секретными переменными](https://docs.ansible.com/ansible/2.9/user_guide/vault.html) в Ansible/<название роли>/vars

        - Создать файл secrets.yml для хранения переменных: postgres, wikiuser, replication user

              # За основу взять ansible_secrets_EXAMPLE
              ansible-vault encrypt db_postgresql/vars/secrets.yml

        - Создать файл .ansible_db_postgresql_vault_pass в корневой директории Ansible с паролем для расшифровки secrets.yml

              # За основу взять .ansible_vault_pass_EXAMPLE

        - Дополнительные команды vault

              # Изменение пароля
              ansible-vault rekey <название файла>
              # Редактирование файла
              ansible-vault edit <название файла>
              # Расшифровка файла
              ansible-vault decrypt <название файла>
              # Просмотр файла
              ansible-vault view <название файла>

        - Cкопировать файл


      - Обновление пакетного репозитория, установка пакетов, создание: БД my_wiki, пользователь wikiuser (основной пользователь БД), пользователь syncuser (для репликации), перенос директории Primary и Standby БД на внешний жесткий диск, настройка репликации, настройка dump

            ansible-playbook playbook.yaml --vault-password-file /root/YP-sp13_MediaWiki/Ansible/.ansible_db_postgresql_vault_pass -i inventory.yaml --tags="setup_db_postgresql"

            


3. Дополнительная информация

- Основные команды для работы с Ansible  
  Выполнять из директории с файлами Ansible
  
  <details>
  <summary>Развернуть</summary>  
      
      # Проверка синтаксиса и доступности облачных ресурсов
      ansible all -m ping -i inventory.yaml  

      # Установка или обновление коллекции
      ansible-galaxy collection install <имя коллекции>  

      # Список установленных коллекций
      ansible-galaxy collection list  

      # Создание роли (исп. для разграничения задач, которые будут выполняться в рамках playbook)
      ansible-galaxy init <название роли>

      # Список используемых ролей
      ansible-galaxy role list  

      # Запуск playbook
      ansible-playbook <название playbook>.yaml -i <название файла с inventory>.yaml --tags="<указать тег>"

        Пример:
        ansible-playbook mount_disks_playbook.yaml -i inventory.yaml --tags="moint_dir"


  </details> 
