<!-- # Настройка Ansible для автоматической конфигурации сервиса -->

#### Настройка Ansible для автоматической конфигурации сервиса

<!-- 1. Копирование приватного ssh-ключа на vm-7-standby-db в /root/.ssh, чтобы иметь возможность подключаться к другим ВМ -->

#### 1. Список настраиваемых файлов/скриптов конфигурации

   - [ansible_structure](python-scripts/ansible_structure.py)

      <details>
      <summary>Развернуть</summary>  

         # Содержит словарь dynamic_groups
         # Он предназначен для выстраивания структуры групп, подгрупп и входящих в них ВМ.
         # Он уже настроен. Но, при необходимости, можно менять структуру файла inventory.yaml

         # Просмотреть список созданных через Terraform ВМ      
         ~/<имя репозитория>/<папка Terraform> terraform output 
         
         # Или в файле ~/<имя репозитория>/<папка Terraform>/
         terraform.tfstate

      </details>

#### 2. Guideline по запуску playbook'ов playbook

   - #### 2.1. Подготовительная работа

      <details>
      <summary>Развернуть</summary>  

      - Автоматическое формирования inventory.yaml  
      Запуск Python-скрипта [**update_ansible_inventory.py**](python-scripts/update_ansible_inventory.py)   
      
            python3 update_ansible_inventory.py

      - Настройка private ssh-key (для подключения к другим ВМ)
      
        - Копирование private ssh-key в роль [db_postgresql/files](/Ansible/db_postgresql/files)  
      
              cp ~/.ssh/id_ed25519 ~/YP-sp13_MediaWiki/Ansible/db_postgresql/files

        - Шифрование с помощью [ansible-vault](https://docs.ansible.com/ansible/2.9/user_guide/vault.html) private ssh-key 

              # Шифрование private ssh-key с vault-id: "ans_vault_ssh"
              ansible-vault encrypt --vault-id ans_vault_ssh@prompt ~/YP-sp13_MediaWiki/Ansible/db_postgresql/files/id_ed25519

      - Настройка secrets.yml (для хранения секретных переменных)

        - Создание и наполнение файла secrets.yml в роль [db_postgresql/vars](/Ansible/db_postgresql/vars)  
        За основу взять [ansible_secrets.yml_EXAMPLE](/credentials/templates/ansible_secrets.yml_EXAMPLE) 

              touch ~/YP-sp13_MediaWiki/Ansible/db_postgresql/vars/secrets.yml

        - Шифрование с помощью [ansible-vault](https://docs.ansible.com/ansible/2.9/user_guide/vault.html) secrets.yml
              
              # Шифрование private ssh-key с vault-id: "ans_vault_secrets"
              ansible-vault encrypt --vault-id ans_vault_secrets@prompt ~/YP-sp13_MediaWiki/Ansible/db_postgresql/vars/secrets.yml


      - Настройка vault_passwords.txt (для хранения паролей ansible-vault)
        - Создание и наполнение файла vault_passwords.txt в корневой директории [Ansible](/Ansible/)  
        За основу взять [ansible_vault_passwords.txt_EXAMPLE](/credentials/templates/ansible_vault_passwords.txt_EXAMPLE) 

              touch ~/YP-sp13_MediaWiki/Ansible/vault_passwords.txt

      - Дополнительные команды vault

            # Изменение пароля
            ansible-vault rekey <название файла>
            # Редактирование файла
            ansible-vault edit <название файла>
            # Расшифровка файла
            ansible-vault decrypt <название файла>
            # Просмотр файла
            ansible-vault view <название файла>


      </details>

   - #### 2.2. Изменение имени хостов всех ВМ
          
         ansible-playbook playbook.yaml -i inventory.yaml --tags="change_hostname"

   - #### 2.3.1. Монтирование внешних жестких дисков, инициализация LVM.  
      - Будут созданы: disk Partition, Physical Volume, Group Volume, Logical Volume, точка монтирования в /opt, запись в /etc/fstab для автомонтирования диска после перезапуска ВМ

            ansible-playbook playbook.yaml -i inventory.yaml --tags="mount_external_disks"

   - #### 2.3.2. Размонтирование внешних жестких дисков, деинициализация LVM.  

      - Будут удалены: disk Partition, Physical Volume, Group Volume, Logical Volume, точка монтирования в /opt

            ansible-playbook playbook.yaml -i inventory.yaml --tags="unmount_external_disks"


   - #### 2.4. Инициализация и настройка postgresql на vm-1-monitoring-system, vm-6-primary-db, vm-7-standby-db

      - Обновление пакетного репозитория, установка пакетов
      - Cоздание БД my_wiki, пользователя wikiuser (основной пользователь БД), пользователя syncuser (для репликации)
      - Перенос директории Primary и Standby БД на внешний жесткий диск
      - Настройка репликации, настройка dump

            ansible-playbook playbook.yaml --vault-id @/root/YP-sp13_MediaWiki/Ansible/vault_passwords.txt -i inventory.yaml --tags="setup_db_postgresql"


#### 3. Дополнительная информация

- Основные команды для работы с Ansible  
  Выполнять из директории с файлами Ansible
  
  <details>
  <summary>Развернуть</summary>  
      
      # Проверка синтаксиса и доступности облачных ресурсов
      ansible all -m ping -i inventory.yaml  

      # Установка или обновление коллекции
      ansible-galaxy collection install <имя коллекции>  

      # Список установленных коллекций
      ansible-galaxy collection list  

      # Создание роли (исп. для разграничения задач, которые будут выполняться в рамках playbook)
      ansible-galaxy init <название роли>

      # Список используемых ролей
      ansible-galaxy role list  

      # Запуск playbook
      ansible-playbook <название playbook>.yaml -i <название файла с inventory>.yaml --tags="<указать тег>"

        Пример:
        ansible-playbook mount_disks_playbook.yaml -i inventory.yaml --tags="moint_dir"


  </details> 
